###############################################################################
# Compute and energy estimation for different models.
# - For SNNs: calculates average spikes per timestep across folds.
# - For SNN/ANN/ML: estimates MACs based on architecture and/or spike counts.
###############################################################################

# Moving average (not used but kept for consistency)
library(pracma)

# ROC AUC (not used but kept for consistency)
library(pROC)

count_spikes <- function(dataset_root, nu1, nu2, n_neuron, threshold, decay, amplitude, epochs, resolution, recurrence, fold_ids) {
  
  # Function to perform spike counts for SNNs, to estimate MACs
  # If non-recurrent, nu2 is irrelevant (use default value)
  if (recurrence == "False") { nu2 <- "0.1_ -0.1" }
  
  # Build path to experiment outputs
  path <- paste(dataset_root, nu1, nu2, n_neuron, threshold, decay, amplitude, epochs, resolution, recurrence, sep = "/")
  
  all_spikes <- c()
  
  # Read experiment outputs for each fold and collect spike data
  for (fold in fold_ids) {
    
    # Read labels and spikes for this fold
    labels <- read.csv(paste0(path, "/label_", fold), header = FALSE)$V1
    labels <- labels[!is.nan(labels)]
    
    spikes <- read.csv(paste0(path, "/spikes_", fold), header = FALSE)$V1
    spikes <- spikes[1:length(labels)]
    
    print(paste0("Fold ", fold, ", spike count: ", mean(spikes)))
    
    # Collect all spikes for averaging
    # Note: Future enhancement could calculate input neuron count as:
    # input_neurons <- ceiling((1 + 2 * amplitude) / resolution)
    all_spikes <- c(all_spikes, spikes)
  }
  
  # Return average spike count per timestep across all folds
  mean(all_spikes)
}

estimate_snn_macs<-function(a){
  # Estimate MACs for SNN models.
  # Expected columns in 'a': 'recurrent' (True/False), 'n' (number of neurons),
  # and 'spike_counts' (average spikes per timestep).
  macs <- rep(NA, nrow(a))
  macs[a$recurrent == "True"] <- as.numeric(a$n)[a$recurrent == "True"] * 
      (a$spike_counts[a$recurrent == "True"] + 2)
  macs[a$recurrent == "False"] <- 2 * as.numeric(a$n)[a$recurrent == "False"]
  a$macs <- macs
  
  a
}

estimate_ann_macs<-function(a){
  # Estimate MACs for various ANN models using pre-computed constants.
  #These estimations are computed by count_macs.py, in folder DLBaselines. They can be updated 
  # by copy and paste the content of code2R.txt, the file generated by count_macs.py.
  
  macs<-rep(NA,nrow(a))
  #######Block automactly generated by count_macs.py###########################
  macs[a$model=="YildirimOzal" & a$length==50]<-474034
  macs[a$model=="YildirimOzal" & a$length==100]<-992708
  macs[a$model=="YildirimOzal" & a$length==150]<-1543542
  macs[a$model=="YildirimOzal" & a$length==200]<-2192875
  macs[a$model=="AdaptiveCaiWenjuan"]<-1001848
  macs[a$model=="AdaptiveOhShuLih"]<-31680
  macs[a$model=="Conv1dAutoencoder" & a$length==50 & a$n_layers==1]<-12000
  macs[a$model=="Conv1dAutoencoder" & a$length==50 & a$n_layers==2]<-201440
  macs[a$model=="Conv1dAutoencoder" & a$length==50 & a$n_layers==3]<-601440
  macs[a$model=="Conv1dAutoencoder" & a$length==100 & a$n_layers==1]<-24000
  macs[a$model=="Conv1dAutoencoder" & a$length==100 & a$n_layers==2]<-413440
  macs[a$model=="Conv1dAutoencoder" & a$length==100 & a$n_layers==3]<-1171200
  macs[a$model=="Conv1dAutoencoder" & a$length==150 & a$n_layers==1]<-36000
  macs[a$model=="Conv1dAutoencoder" & a$length==150 & a$n_layers==2]<-609440
  macs[a$model=="Conv1dAutoencoder" & a$length==150 & a$n_layers==3]<-1735840
  macs[a$model=="Conv1dAutoencoder" & a$length==200 & a$n_layers==1]<-48000
  macs[a$model=="Conv1dAutoencoder" & a$length==200 & a$n_layers==2]<-821440
  macs[a$model=="Conv1dAutoencoder" & a$length==200 & a$n_layers==3]<-2388800
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==20 & a$n_layers==1]<-8640
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==20 & a$n_layers==2]<-17216
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==20 & a$n_layers==3]<-25792
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==50 & a$n_layers==1]<-12480
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==50 & a$n_layers==2]<-21056
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==32 & a$latent==50 & a$n_layers==3]<-29632
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==20 & a$n_layers==1]<-25472
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==20 & a$n_layers==2]<-59008
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==20 & a$n_layers==3]<-92544
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==50 & a$n_layers==1]<-33152
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==50 & a$n_layers==2]<-66688
  macs[a$model=="LSTMAutoencoder" & a$length==50 & a$hidden==64 & a$latent==50 & a$n_layers==3]<-100224
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==20 & a$n_layers==1]<-10240
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==20 & a$n_layers==2]<-18816
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==20 & a$n_layers==3]<-27392
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==50 & a$n_layers==1]<-14080
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==50 & a$n_layers==2]<-22656
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==32 & a$latent==50 & a$n_layers==3]<-31232
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==20 & a$n_layers==1]<-28672
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==20 & a$n_layers==2]<-62208
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==20 & a$n_layers==3]<-95744
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==50 & a$n_layers==1]<-36352
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==50 & a$n_layers==2]<-69888
  macs[a$model=="LSTMAutoencoder" & a$length==100 & a$hidden==64 & a$latent==50 & a$n_layers==3]<-103424
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==20 & a$n_layers==1]<-11840
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==20 & a$n_layers==2]<-20416
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==20 & a$n_layers==3]<-28992
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==50 & a$n_layers==1]<-15680
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==50 & a$n_layers==2]<-24256
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==32 & a$latent==50 & a$n_layers==3]<-32832
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==20 & a$n_layers==1]<-31872
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==20 & a$n_layers==2]<-65408
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==20 & a$n_layers==3]<-98944
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==50 & a$n_layers==1]<-39552
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==50 & a$n_layers==2]<-73088
  macs[a$model=="LSTMAutoencoder" & a$length==150 & a$hidden==64 & a$latent==50 & a$n_layers==3]<-106624
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==20 & a$n_layers==1]<-13440
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==20 & a$n_layers==2]<-22016
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==20 & a$n_layers==3]<-30592
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==50 & a$n_layers==1]<-17280
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==50 & a$n_layers==2]<-25856
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==32 & a$latent==50 & a$n_layers==3]<-34432
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==20 & a$n_layers==1]<-35072
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==20 & a$n_layers==2]<-68608
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==20 & a$n_layers==3]<-102144
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==50 & a$n_layers==1]<-42752
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==50 & a$n_layers==2]<-76288
  macs[a$model=="LSTMAutoencoder" & a$length==200 & a$hidden==64 & a$latent==50 & a$n_layers==3]<-109824
  ##########################################################################################
  
  a$macs<-macs
  a
}

estimate_ml_macs<-function(a){
  # Estimate MACs for classic ML methods (ocsvm, lof) using closed-form formulas.
  macs<-rep(NA,nrow(a))
  
  macs[a$model=="ocsvm"]<-a$n_vectors[a$model=="ocsvm"]*(2*a$length[a$model=="ocsvm"]+2)
  macs[a$model=="lof"]<-2*a$length[a$model=="lof"]+(a$neighbours[a$model=="lof"]+1)^2+
      a$neighbours[a$model=="lof"]+1
  
  a$macs<-macs
  
  a
}